import{JNode,JMain}from"./jqre.js";class JEventHandler{constructor(){this.functionMap={}}addEventListener(t,n,e,i=!1,o=null,l=null){this.functionMap[n]=this.functionMap[n]??[];let s=this.handleEvent.bind(this,n,{target:t,listener:e,selector:o,data:l});this.functionMap[n].push({target:t,listener:e,selector:o,data:l,useCapture:i,eventListener:s}),t.addEventListener(n.split(".")[0],s,i),this.garbageCollect()}removeEventListener(t,n=null,e=null,i=!1,o=null){const l=[];if(null===n)l.push.apply(l,Object.keys(this.functionMap));else if(this.functionMap[n])for(const t in this.functionMap)t!==n&&0!==t.indexOf(n+".")||l.push(t);for(n of l){let l=0;for(;l<this.functionMap[n].length;){const s=this.functionMap[n][l];t!==s.target||null!==e&&e!==s.listener||null!==o&&o!==s.selector?l++:(t.removeEventListener(n.split(".")[0],s.eventListener,i),this.functionMap[n].splice(l,1))}}this.garbageCollect()}handleEvent(t,n,e){if(null!==n.data&&(e.data=n.data),!t.includes(".")&&!e.namespace||e.namespace===t.split(".").slice(1).join("."))if(n.selector){for(const t of Array.from(n.target.querySelectorAll(JMain._internal.fixSelector(n.selector))))if(t.contains(e.target))return e.delegateTarget=n.target,void n.listener.call(t,e)}else n.listener.call(e.currentTarget,e)}garbageCollect(){for(let t in this.functionMap){let n=0;for(;n<this.functionMap[t].length;){const e=this.functionMap[t][n];document.contains(e.target)?n++:this.functionMap[t].splice(n,1)}}}triggerEvent(t,n,e,i,o){const l=new o(n.split(".")[0],null===i?{bubbles:!0}:i);l.namespace=n.includes(".")?n.split(".").slice(1).join("."):"";for(const t in e)l[t]=e[t];t.dispatchEvent(l)}}JNode.prototype.off=function(t=null,n=null,e=null,i=null){if(null!==i);else if(null!==e)"function"!=typeof e&&(i=e,e=null,"function"==typeof n&&(e=n,n=null));else if(null!==n&&"string"!=typeof n)if("function"==typeof n)e=n,n=null;else i=n,n=null;if(null!==t&&"object"==typeof t)for(const e in t)this.off(e,n,t[e],i);else{"string"==typeof t&&(t=t.split(" "));for(const o of this)if(Array.isArray(t))for(const l of t)JMain._internal.eventHandler.removeEventListener(o,l,e,i,n);else t instanceof Event?JMain._internal.eventHandler.removeEventListener(o,t.type,null,i):null===t?JMain._internal.eventHandler.removeEventListener(o):JMain._internal.eventHandler.removeEventListener(o,null,null,t)}return this},JNode.prototype.on=function(t,n=null,e=null,i=null,o=null){if(null!==t&&"object"==typeof t){for(let o in t)"string"==typeof n?null!==e&&"object"==typeof e?this.on(o,n,e,t[o],i):this.on(o,n,null,t[o],e):null!==n&&"object"==typeof n?this.on(o,null,n,t[o],e):this.on(o,null,null,t[o],n);return this}t=t.split(" ");for(const l of this)for(const s in t)"function"==typeof i?JMain._internal.eventHandler.addEventListener(l,t[s],i,o,n,e):"function"==typeof e?"string"==typeof n||null===n?JMain._internal.eventHandler.addEventListener(l,t[s],e,i,n):JMain._internal.eventHandler.addEventListener(l,t[s],e,i,null,n):JMain._internal.eventHandler.addEventListener(l,t[s],n,e);return this},JNode.prototype.swipe=function(t){if("boolean"==typeof t)return void(t||this.trigger("swipeoff"));const n={x:-1,y:-1,t:0,els:this,currentEl:null,callback:t};return n.start=function(t){t.preventDefault(),t.stopPropagation(),this.x=t.clientX,this.y=t.clientY,this.currentEl=t.currentTarget}.bind(n),n.reset=function(){this.x=-1,this.y=-1}.bind(n),n.swipeoff=function(){this.els.off("mousedown",this.start).off("swipeoff",this.swipeoff),(new JNode).add(document).off("mousedown",this.reset).off("mouseup",this.end)}.bind(n),n.end=function(t){if(this.x>-1&&this.y>-1){const n=t.clientX,e=t.clientY,i=Math.abs(this.x-n),o=Math.abs(this.y-e);let l="";o>i?o>Math.max(100,.1*window.innerHeight)&&(l=this.y>e?"up":"down"):i>Math.max(100,.1*window.innerWidth)&&(l=this.x>n?"left":"right"),l&&this.callback.call(this.currentEl,l)}}.bind(n),this.on("mousedown",n.start).on("swipeoff",n.swipeoff),(new JNode).add(document).on("mousedown",n.reset).on("mouseup",n.end),this},JNode.prototype.trigger=function(t,n=null,e=null,i=Event){for(const o of this)JMain._internal.eventHandler.triggerEvent(o,t,n,e,i);return this},JMain.touchPunch=function(t=!0){if(!window.hasOwnProperty("ontouchend"))return;if(!t)return void(new JNode).add(document).trigger("touchpunchoff");const n={touchHandled:!1,simulate:function(t,n){if(t.changedTouches.length>1)return;const e=t.changedTouches[0];t.target.dispatchEvent(new MouseEvent(n,{bubbles:!0,cancelable:!0,view:window,detail:1,screenX:e?e.screenX:null,screenY:e?e.screenY:null,clientX:e?e.clientX:null,clientY:e?e.clientY:null,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:0,relatedTarget:null}))}};n.start=function(t){this.touchHandled||(this.touchHandled=!0,this.simulate(t,"mouseover"),this.simulate(t,"mousemove"),this.simulate(t,"mousedown"))}.bind(n),n.move=function(t){this.touchHandled&&this.simulate(t,"mousemove")}.bind(n),n.end=function(t){this.touchHandled&&(this.simulate(t,"mouseup"),this.simulate(t,"mouseout"),this.touchHandled=!1)}.bind(n),n.touchpunchoff=function(){(new JNode).add(document).off("touchstart",this.start).off("touchmove",this.move).off("touchend",this.end).off("touchpunchoff",this.touchpunchoff)}.bind(n),(new JNode).add(document).on("touchstart",n.start).on("touchmove",n.move).on("touchend",n.end).on("touchpunchoff",n.touchpunchoff)},JMain._internal.eventHandler=new JEventHandler,JMain._internal.runEventShorthand=function(t,n=null,e=null){return null===n?this.trigger(t):this.on(t,n,e),this};