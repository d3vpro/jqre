import{JNode,JMain}from"./jqre.js";class ReactiveVar{constructor(t){Object.defineProperty(this,"id",{value:t,writable:!1})}val(){let t=JMain.r.get(this.id);return/boolean|number|string/.test(typeof t)?t:JSON.parse(JSON.stringify(t))}set(t,e=void 0){return JMain.r.set(this.id,t,e)}unset(t=null){return null!==t&&JMain.r.unset(this.id,t)}}class Reactive{constructor(t,e){let a,n=null;e.parent.length>0?(a=Reactive.data.instances[e.parent].$el.find(e.el,!0),n=Reactive.data.instances[e.parent].$el):a=(new JNode).add(e.el,!0),Object.defineProperty(this,"$id",{value:t,writable:!1}),Object.defineProperty(this,"$el",{value:a,writable:!1}),Object.defineProperty(this,"$parent",{value:n,writable:!1});for(const t in e.data)Object.defineProperty(this,t,{value:e.data[t],writable:!0});for(const t in e.methods)Object.defineProperty(this,t,{value:e.methods[t],writable:!0})}$emit(t,e=null){let a=this.$id;const n=a.split(".");for(;a.length;){if(Reactive.data.instancesCustomEvents[a][t])return Reactive.data.instancesCustomEvents[a][t].call(Reactive.data.instances[a],e),!0;n.pop(),a=n.join(".")}return!1}$find(t){return this.$el.find(t)}$remove(t){const e=this.$el.find(t);e.length&&(Reactive.data.instancesRestoreData[this.$id]||(Reactive.data.instancesRestoreData[this.$id]={}),Reactive.data.instancesRestoreData[this.$id][t]||(Reactive.data.instancesRestoreData[this.$id][t]=[]));for(const[a,n]of e.entries()){let e=document.createComment(this.$id+" "+t+" "+a);n.parentNode.replaceChild(e,n),Reactive.data.instancesRestoreData[this.$id][t].push({node:e,html:n})}}$restore(t){if(Reactive.data.instancesRestoreData[this.$id]&&Reactive.data.instancesRestoreData[this.$id][t]){for(const e of Reactive.data.instancesRestoreData[this.$id][t])e.node.parentNode.replaceChild(e.html,e.node);delete Reactive.data.instancesRestoreData[this.$id][t]}}static reactiveMap=new WeakMap;static initReactive(t,e,a=!0){const n=new Proxy(t,{get(t,e){if("__isProxy"==e)return!0;const a=Reactive.reactiveMap.get(t);let n;if(a.root){if(n=t[e],!(n instanceof ReactiveVar))return"function"!=typeof n||["$emit","$find","$remove","$restore"].includes(e)?t[e]:n.bind(a.proxy);n=JMain.r.get(n.id)}else n=t[e];return"object"!=typeof n||null===n||n.__isProxy?n:Reactive.reactiveMap.has(n)?Reactive.reactiveMap.get(n).proxy:Reactive.initReactive(n,a.root?a.path+"."+e:a.path,!1)},set(t,e,a){if("length"===e&&Array.isArray(t))return t[e]=a,!0;{const n=Reactive.reactiveMap.get(t);if(n.root){if(!(t[e]instanceof ReactiveVar))return!1;JMain.r.set(t[e],a)}else{const s=t[e];t[e]=a,JMain.r.refresh(n.path,null,s)}return!0}},deleteProperty(t,e){const a=Reactive.reactiveMap.get(t);if(a.root){if(!(t[e]instanceof ReactiveVar))return;JMain.r.unset(a.path+"."+e)}else{const n=t[e];delete t[e],JMain.r.refresh(a.path,null,n)}}});return Reactive.reactiveMap.set(t,{path:e,proxy:n,root:a}),n}}Reactive.data={definitions:{},instances:{},instancesCustomEvents:{},instancesRestoreData:{},state:{},stateUpdateEvents:{}},JMain.r={listDefinitions:function(){return Object.keys(Reactive.data.definitions)},listInstances:function(){return Object.keys(Reactive.data.instances)},listInstancesCustomEvents:function(){const t={};for(const e in Reactive.data.instancesCustomEvents)t[e]=Object.keys(Reactive.data.instancesCustomEvents[e]);return t},listInstancesRestoreData:function(){const t={};for(const e in Reactive.data.instancesRestoreData)t[e]=Object.keys(Reactive.data.instancesRestoreData[e]);return t},listState:function(){return Object.keys(Reactive.data.state)},listStateUpdateEvents:function(){const t={};for(const e in Reactive.data.stateUpdateEvents)t[e]=Reactive.data.stateUpdateEvents[e].filter((t=>void 0!==t)).length;return t},define:function(t,e){if(Reactive.data.definitions[t])return!1;const a={};return a.components=e.components??{},a.data=e.data??{},a.events=e.events??{},a.methods=e.methods??{},Reactive.data.definitions[t]=a,!0},init:function(t,e){const a=Reactive.data.definitions[e.type];if(!a)return console.error(`Type '${e.type}' not defined!`),!1;if(a.el=e.el,a.type=e.type,a.parent=t.includes(".")?t.split(".").slice(0,-1).join("."):"",e.data)for(const t in e.data)a.data.hasOwnProperty(t)&&(a.data[t]=e.data[t]);if(e.components)for(const t in e.components){const n=Reactive.data.definitions[a.components[t].type];if(!n)return console.error(`Type '${a.components[t].type}' not defined!`),!1;if(a.components[t].hasOwnProperty("data")||(a.components[t].data={}),e.components[t].data)for(const s in e.components[t].data)n.data.hasOwnProperty(s)&&(a.components[t].data[s]=e.components[t].data[s]);e.components[t].components&&(a.components[t].components=e.components[t].components)}for(const e in a.components)if(a.components[e].data)for(const n in a.components[e].data){const s=a.components[e].data[n];s instanceof ReactiveVar&&"this"===s.id.split(".")[0]&&(a.components[e].data[n]=JMain.r.ref(t+"."+s.id.substr(5)))}for(const e in a.data)a.data[e]instanceof ReactiveVar||(JMain.r.set(t+"."+e,a.data[e]),a.data[e]=JMain.r.ref(t+"."+e));Reactive.data.instances[t]=Reactive.initReactive(new Reactive(t,a),t),Reactive.data.instancesCustomEvents[t]={};const n=[];if(a.events){if(a.events.create&&a.events.create.call(Reactive.data.instances[t]),a.events.update)for(const e in a.data)a.events.update[e]&&(JMain.r.attach(a.data[e],a.events.update[e],t),n.push(a.data[e]));for(const e in a.events)if("create"!==e&&"update"!==e)if("object"==typeof a.events[e])for(const n in a.events[e]){let s=a.events[e][n],i=null,c={};"function"!=typeof s&&(c=s.data??{},i=s.useCapture??null,s=s.handler),Reactive.data.instances[t].$el.on(e,n,c,s.bind(Reactive.data.instances[t]),i)}else Reactive.data.instancesCustomEvents[t][e]=a.events[e]}for(const e in a.components)JMain.r.init(t+"."+e,a.components[e]);for(const t of n)JMain.r.refresh(t);return!0},trigger:function(t,e,a=null){return!!Reactive.data.instances.hasOwnProperty(t)&&Reactive.data.instances[t].$emit(e,a)},destroy:function(t){if(!t.includes(".")&&Reactive.data.instances.hasOwnProperty(t)){const e=t+".",a=e.length;for(const t in Reactive.data.state)t.substr(0,a)===e&&JMain.r.unset(t);for(const t in Reactive.data.instancesCustomEvents)t.substr(0,a)===e&&delete Reactive.data.instancesCustomEvents[t];delete Reactive.data.instancesCustomEvents[t];for(const t in Reactive.data.instancesRestoreData)if(t.substr(0,a)===e){for(const e in Reactive.data.instancesRestoreData[t])Reactive.data.instances[t].$restore(e);delete Reactive.data.instancesRestoreData[t]}if(Reactive.data.instancesRestoreData[t]){for(const e in Reactive.data.instancesRestoreData[t])Reactive.data.instances[t].$restore(e);delete Reactive.data.instancesRestoreData[t]}for(const t in Reactive.data.instances)t.substr(0,a)===e&&(Reactive.data.instances[t].$el.off(),delete Reactive.data.instances[t]);return Reactive.data.instances[t].$el.off(),delete Reactive.data.instances[t],!0}return!1},get:function(t){return"string"!=typeof t&&(t=t.id),t?Reactive.data.state[t]??null:null},ref:function(t){return new ReactiveVar(t)},attach:function(t,e,a=null){if("string"!=typeof t&&(t=t.id),t&&Reactive.data.stateUpdateEvents[t]){for(const n in Reactive.data.stateUpdateEvents[t])if(Reactive.data.stateUpdateEvents[t][n].handler===e&&Reactive.data.stateUpdateEvents[t][n].instanceId===a)return n}else Reactive.data.stateUpdateEvents[t]=[];return Reactive.data.stateUpdateEvents[t].push({handler:e,instanceId:a})-1},deattach:function(t,e=null,a=null){if("string"!=typeof t&&(t=t.id),Reactive.data.stateUpdateEvents[t])if("function"==typeof e){for(const n in Reactive.data.stateUpdateEvents[t])if(Reactive.data.stateUpdateEvents[t][n].handler===e&&Reactive.data.stateUpdateEvents[t][n].instanceId===a)return delete Reactive.data.stateUpdateEvents[t][n],!0}else{if(isNaN(e))return delete Reactive.data.stateUpdateEvents[t],!0;if(Reactive.data.stateUpdateEvents[t][e])return delete Reactive.data.stateUpdateEvents[t][e],!0}return!1},refresh:async function(t,e=null,a=void 0){if("string"!=typeof t&&(t=t.id),Reactive.data.stateUpdateEvents[t]){if(void 0===a&&(a=JMain.r.get(t)),!e){let e=!1;for(const n in Reactive.data.stateUpdateEvents[t])Reactive.data.stateUpdateEvents[t][n]&&(Reactive.data.stateUpdateEvents[t][n].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][n].instanceId],a),e=!0);return e}if("function"==typeof e){for(const n in Reactive.data.stateUpdateEvents[t])if(Reactive.data.stateUpdateEvents[t][n].handler===e)return Reactive.data.stateUpdateEvents[t][n].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][n].instanceId],a),!0}else if(!isNaN(e)&&Reactive.data.stateUpdateEvents[t][e])return Reactive.data.stateUpdateEvents[t][e].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][e].instanceId],a),!0}return!1},set:function(t,e,a=void 0){"string"!=typeof t&&(t=t.id);let n,s=JMain.r.get(t);if(s=/boolean|number|string/.test(typeof s)?s:JSON.parse(JSON.stringify(s)),void 0===a)n=e;else{if(n=/boolean|number|string/.test(typeof s)?s:JSON.parse(JSON.stringify(s)),"object"!=typeof n||null===n)return!1;n[e]=a}let i=!1;return i=/boolean|number|string/.test(typeof s)&&/boolean|number|string/.test(typeof variable)?s!==n:JSON.stringify(s)!==JSON.stringify(n),i&&(void 0===a?Reactive.data.state[t]=e:Reactive.data.state[t][e]=a,JMain.r.refresh(t,null,s)),!0},unset:function(t,e=null){"string"!=typeof t&&(t=t.id);const a=JMain.r.get(t),n=/boolean|number|string/.test(typeof a)?a:JSON.parse(JSON.stringify(a));if(null!==e){if("object"==typeof a&&null!==a&&e in a)return delete Reactive.data.state[t][e],Array.isArray(a)&&(Reactive.data.state[t]=a.filter((t=>void 0!==t))),JMain.r.refresh(t,null,n),!0}else if(t in Reactive.data.state){if(null==a);else if(Array.isArray(a))Reactive.data.state[t]=[];else switch(typeof a){case"object":Reactive.data.state[t]={};break;case"boolean":Reactive.data.state[t]=!1;break;case"string":Reactive.data.state[t]="";break;case"number":case"bigint":Reactive.data.state[t]=0;break;default:Reactive.data.state[t]=null}return JMain.r.refresh(t,null,n),delete Reactive.data.state[t],delete Reactive.data.stateUpdateEvents[t],!0}return!1}},JMain.r.data={definitions:Reactive.data.definitions,instances:Reactive.data.instances,instancesCustomEvents:Reactive.data.instancesCustomEvents,instancesRestoreData:Reactive.data.instancesRestoreData,state:Reactive.data.state,stateUpdateEvents:Reactive.data.stateUpdateEvents,map:Reactive.reactiveMap};