import{JNode,JMain}from"./jqre.js";class ReactiveVar{constructor(t){Object.defineProperty(this,"id",{value:t,writable:!1})}val(){let t=JMain.r.get(this.id);return/boolean|number|string/.test(typeof t)?t:JSON.parse(JSON.stringify(t))}set(t,e){return JMain.r.set(this.id,t,e)}unset(t=null){return null!==t&&JMain.r.unset(this.id,t)}}class Reactive{constructor(t,e){let a,n=null;e.parent.length>0?(a=Reactive.data.instances[e.parent].$el.find(e.el,!0),n=Reactive.data.instances[e.parent].$el):a=(new JNode).add(e.el,!0),Object.defineProperty(this,"$id",{value:t,writable:!1}),Object.defineProperty(this,"$el",{value:a,writable:!1}),Object.defineProperty(this,"$parent",{value:n,writable:!1});for(const t in e.data)Object.defineProperty(this,t,{value:e.data[t],writable:!1});for(const t in e.methods)Object.defineProperty(this,t,{value:e.methods[t].bind(this),writable:!1})}$emit(t,e=null){let a=this.$id;const n=a.split(".");for(;a.length;){if(Reactive.data.instancesCustomEvents[a][t])return Reactive.data.instancesCustomEvents[a][t].call(Reactive.data.instances[a],e),!0;n.pop(),a=n.join(".")}return!1}$find(t){return this.$el.find(t)}$remove(t){const e=this.$el.find(t);e.length&&(Reactive.data.instancesRestoreData[this.$id]||(Reactive.data.instancesRestoreData[this.$id]={}),Reactive.data.instancesRestoreData[this.$id][t]||(Reactive.data.instancesRestoreData[this.$id][t]=[]));for(const[a,n]of e.entries()){let e=document.createComment(this.$id+" "+t+" "+a);n.parentNode.replaceChild(e,n),Reactive.data.instancesRestoreData[this.$id][t].push({node:e,html:n})}}$restore(t){if(Reactive.data.instancesRestoreData[this.$id]&&Reactive.data.instancesRestoreData[this.$id][t]){for(const e of Reactive.data.instancesRestoreData[this.$id][t])e.node.parentNode.replaceChild(e.html,e.node);delete Reactive.data.instancesRestoreData[this.$id][t]}}}Reactive.data={definitions:{},instances:{},instancesCustomEvents:{},instancesRestoreData:{},state:{},stateUpdateEvents:{}},JMain.r={listDefinitions:function(){return Object.keys(Reactive.data.definitions)},listInstances:function(){return Object.keys(Reactive.data.instances)},listInstancesCustomEvents:function(){const t={};for(const e in Reactive.data.instancesCustomEvents)t[e]=Object.keys(Reactive.data.instancesCustomEvents[e]);return t},listInstancesRestoreData:function(){const t={};for(const e in Reactive.data.instancesRestoreData)t[e]=Object.keys(Reactive.data.instancesRestoreData[e]);return t},listState:function(){return Object.keys(Reactive.data.instances)},listStateUpdateEvents:function(){const t={};for(const e in Reactive.data.stateUpdateEvents)t[e]=Reactive.data.stateUpdateEvents[e].filter((t=>void 0!==t)).length;return t},define:function(t,e){if(Reactive.data.definitions[t])return!1;const a={};return a.components=e.components??{},a.data=e.data??{},a.events=e.events??{},a.methods=e.methods??{},Reactive.data.definitions[t]=a,!0},init:function(t,e){const a=Reactive.data.definitions[e.type];if(!a)return!1;if(a.el=e.el,a.type=e.type,a.parent=t.includes(".")?t.split(".").slice(0,-1).join("."):"",e.data)for(const t in e.data)a.data.hasOwnProperty(t)&&(a.data[t]=e.data[t]);if(e.components)for(const t in e.components){const n=Reactive.data.definitions[a.components[t].type];if(!n)return!1;if(e.components[t].data)for(const s in e.components[t].data)n.data.hasOwnProperty(s)&&(a.components[t].data[s]=e.components[t].data[s])}for(const e in a.components)if(a.components[e].data)for(const n in a.components[e].data){const s=a.components[e].data[n];s instanceof ReactiveVar&&"this"===s.id.split(".")[0]&&(a.components[e].data[n]=JMain.r.ref(t+"."+s.id.substr(5)))}for(const e in a.data)a.data[e]instanceof ReactiveVar||(JMain.r.set(t+"."+e,a.data[e]),a.data[e]=JMain.r.ref(t+"."+e));Reactive.data.instances[t]=new Reactive(t,a),Reactive.data.instancesCustomEvents[t]={};const n=[];if(a.events){if(a.events.create&&a.events.create.call(Reactive.data.instances[t]),a.events.update)for(const e in a.data)a.events.update[e]&&(JMain.r.attach(a.data[e],a.events.update[e],t),n.push(a.data[e]));for(const e in a.events)if("create"!==e&&"update"!==e)if("object"==typeof a.events[e])for(const n in a.events[e]){let s=a.events[e][n],i=null,c={};"function"!=typeof s&&(c=s.data??{},i=s.useCapture??null,s=s.handler),Reactive.data.instances[t].$el.on(e,n,c,s.bind(Reactive.data.instances[t]),i)}else Reactive.data.instancesCustomEvents[t][e]=a.events[e]}for(const e in a.components)JMain.r.init(t+"."+e,a.components[e]);for(const t of n)JMain.r.refresh(t);return!0},trigger:function(t,e,a=null){return!!Reactive.data.instances.hasOwnProperty(t)&&Reactive.data.instances[t].$emit(e,a)},destroy:function(t){if(!t.includes(".")&&Reactive.data.instances.hasOwnProperty(t)){const e=t+".",a=e.length;for(const t in Reactive.data.state)t.substr(0,a)===e&&JMain.r.unset(t);for(const t in Reactive.data.instancesCustomEvents)t.substr(0,a)===e&&delete Reactive.data.instancesCustomEvents[t];delete Reactive.data.instancesCustomEvents[t];for(const t in Reactive.data.instancesRestoreData)if(t.substr(0,a)===e){for(const e in Reactive.data.instancesRestoreData[t])Reactive.data.instances[t].$restore(e);delete Reactive.data.instancesRestoreData[t]}for(const e in Reactive.data.instancesRestoreData[t])Reactive.data.instances[t].$restore(e);delete Reactive.data.instancesRestoreData[t];for(const t in Reactive.data.instances)t.substr(0,a)===e&&(Reactive.data.instances[t].$el.off(),delete Reactive.data.instances[t]);return Reactive.data.instances[t].$el.off(),delete Reactive.data.instances[t],!0}return!1},get:function(t){return"string"!=typeof t&&(t=t.id),t?Reactive.data.state[t]??null:null},ref:function(t){return new ReactiveVar(t)},attach:function(t,e,a=null){if("string"!=typeof t&&(t=t.id),t&&Reactive.data.stateUpdateEvents[t]){for(const n in Reactive.data.stateUpdateEvents[t])if(Reactive.data.stateUpdateEvents[t][n].handler===e&&Reactive.data.stateUpdateEvents[t][n].instanceId===a)return n}else Reactive.data.stateUpdateEvents[t]=[];return Reactive.data.stateUpdateEvents[t].push({handler:e,instanceId:a})-1},deattach:function(t,e=null,a=null){if("string"!=typeof t&&(t=t.id),Reactive.data.stateUpdateEvents[t])if("function"==typeof e){for(const n in Reactive.data.stateUpdateEvents[t])if(Reactive.data.stateUpdateEvents[t][n].handler===e&&Reactive.data.stateUpdateEvents[t][n].instanceId===a)return delete Reactive.data.stateUpdateEvents[t][n],!0}else{if(isNaN(e))return delete Reactive.data.stateUpdateEvents[t],!0;if(Reactive.data.stateUpdateEvents[t][e])return delete Reactive.data.stateUpdateEvents[t][e],!0}return!1},refresh:function(t,e=null,a){if("string"!=typeof t&&(t=t.id),Reactive.data.stateUpdateEvents[t]){if(void 0===a&&(a=JMain.r.get(t)),!e){let e=!1;for(const n in Reactive.data.stateUpdateEvents[t])Reactive.data.stateUpdateEvents[t][n]&&(Reactive.data.stateUpdateEvents[t][n].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][n].instanceId],a),e=!0);return e}if("function"==typeof e){for(const n in Reactive.data.stateUpdateEvents[t])if(Reactive.data.stateUpdateEvents[t][n].handler===e)return Reactive.data.stateUpdateEvents[t][n].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][n].instanceId],a),!0}else if(!isNaN(e)&&Reactive.data.stateUpdateEvents[t][e])return Reactive.data.stateUpdateEvents[t][e].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][e].instanceId],a),!0}return!1},set:function(t,e,a){"string"!=typeof t&&(t=t.id);const n=JMain.r.get(t);if(void 0===a)a=e;else{const t=a;if("object"!=typeof(a=/boolean|number|string/.test(typeof n)?n:JSON.parse(JSON.stringify(n)))||null===a)return!1;a[e]=t}let s=!1;return/boolean|number|string/.test(typeof n)&&/boolean|number|string/.test(typeof variable)?s=n!==a:(s=JSON.stringify(n)!==JSON.stringify(a),a=JSON.parse(JSON.stringify(a))),s&&(Reactive.data.state[t]=a,JMain.r.refresh(t,null,n)),!0},unset:function(t,e=null){if("string"!=typeof t&&(t=t.id),null!==e){const a=JMain.r.get(t);if("object"==typeof a&&null!==a&&a[e]){let n;return Array.isArray(a)?(n=JSON.parse(JSON.stringify(a)),delete n[e],n=n.filter((t=>void 0!==t))):(n=Object.assign({},a),delete n[e]),JMain.r.set(t,n)}}else if(Reactive.data.state[t]){let e=JMain.r.get(t);if(e=/boolean|number|string/.test(typeof e)?e:JSON.parse(JSON.stringify(e)),null==e)Reactive.data.state[t]=e;else if(Array.isArray(e))Reactive.data.state[t]=[];else switch(typeof e){case"object":Reactive.data.state[t]={};break;case"boolean":Reactive.data.state[t]=!1;break;case"string":Reactive.data.state[t]="";break;case"number":case"bigint":Reactive.data.state[t]=0;break;default:Reactive.data.state[t]=null}if(Reactive.data.stateUpdateEvents[t])for(const a in Reactive.data.stateUpdateEvents[t])Reactive.data.stateUpdateEvents[t][a]&&Reactive.data.stateUpdateEvents[t][a].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[t][a].instanceId],e);return delete Reactive.data.state[t],delete Reactive.data.stateUpdateEvents[t],!0}return!1}},JMain.r.data={definitions:Reactive.data.definitions,instances:Reactive.data.instances,instancesCustomEvents:Reactive.data.instancesCustomEvents,instancesRestoreData:Reactive.data.instancesRestoreData,state:Reactive.data.state,stateUpdateEvents:Reactive.data.stateUpdateEvents};