import{JNode,JMain}from"./jqre.js";class ReactiveVar{constructor(e){Object.defineProperty(this,"id",{value:e,writable:!1})}val(){let e=JMain.r.get(this.id);return/boolean|number|string/.test(typeof e)?e:JSON.parse(JSON.stringify(e))}set(e,t=void 0){return JMain.r.set(this.id,e,t)}unset(e=null){return null!==e&&JMain.r.unset(this.id,e)}}class Reactive{constructor(e,t){let a,n=null;t.parent.length>0?(a=Reactive.data.instances[t.parent].$el.find(t.el,!0),n=Reactive.data.instances[t.parent]):a=(new JNode).add(t.el,!0),Object.defineProperty(this,"$id",{value:e,writable:!1}),Object.defineProperty(this,"$el",{value:a,writable:!1}),Object.defineProperty(this,"$parent",{value:n,writable:!1}),Object.defineProperty(this,"$children",{value:{},writable:!0});for(const e in t.data)Object.defineProperty(this,e,{value:t.data[e],writable:!0});for(const e in t.methods)Object.defineProperty(this,e,{value:t.methods[e],writable:!0})}$emit(e,t=null){let a=this.$id;const n=a.split(".");for(;a.length;){if(Reactive.data.instancesCustomEvents[a][e]){const n=Reactive.delayRefresh;return n||(Reactive.delayRefresh=!0),Reactive.data.instancesCustomEvents[a][e].call(Reactive.data.instances[a],t),n||(Reactive.delayRefresh=!1,JMain.r.refresh(null)),!0}n.pop(),a=n.join(".")}return!1}$find(e){return this.$el.find(e)}$remove(e){const t=this.$el.find(e);t.length&&(Reactive.data.instancesRestoreData[this.$id]||(Reactive.data.instancesRestoreData[this.$id]={}),Reactive.data.instancesRestoreData[this.$id][e]||(Reactive.data.instancesRestoreData[this.$id][e]=[]));for(const[a,n]of t.entries()){let t=document.createComment(this.$id+" "+e+" "+a);n.parentNode.replaceChild(t,n),Reactive.data.instancesRestoreData[this.$id][e].push({node:t,html:n})}}$restore(e){if(Reactive.data.instancesRestoreData[this.$id]&&Reactive.data.instancesRestoreData[this.$id][e]){for(const t of Reactive.data.instancesRestoreData[this.$id][e])t.node.parentNode.replaceChild(t.html,t.node);delete Reactive.data.instancesRestoreData[this.$id][e]}}static delayRefresh=!1;static refreshDelayedList=new Set;static reactiveMap=new WeakMap;static initReactive(e,t,a=!0){const n=new Proxy(e,{get(e,t){if("__isProxy"==t)return!0;const a=Reactive.reactiveMap.get(e);let n;if(a.root){if(n=e[t],!(n instanceof ReactiveVar)){if("function"!=typeof n||["$emit","$find","$remove","$restore"].includes(t)){if("$children"==t){e[t]={};for(const a in Reactive.data.instances)a.length>e.$id.length&&0===a.indexOf(e.$id)&&a.split(".").length===e.$id.split(".").length+1&&(e[t][a.substring(e.$id.length+1)]=Reactive.data.instances[a]);return e[t]}return e[t]}return n.bind(a.proxy)}n=JMain.r.get(n.id)}else n=e[t];return"object"!=typeof n||null===n||n.__isProxy?n:Reactive.reactiveMap.has(n)?Reactive.reactiveMap.get(n).proxy:Reactive.initReactive(n,a.root?a.path+"."+t:a.path,!1)},set(e,t,a){if("length"===t&&Array.isArray(e))return e[t]=a,!0;{const n=Reactive.reactiveMap.get(e);if(n.root){if(!(e[t]instanceof ReactiveVar))return!1;JMain.r.set(e[t],a)}else{const i=e[t];e[t]=a,JMain.r.refresh(n.path,null,i)}return!0}},deleteProperty(e,t){const a=Reactive.reactiveMap.get(e);if(a.root){if(!(e[t]instanceof ReactiveVar))return;JMain.r.unset(a.path+"."+t)}else{const n=e[t];delete e[t],JMain.r.refresh(a.path,null,n)}return!0}});return Reactive.reactiveMap.set(e,{path:t,proxy:n,root:a}),n}}Reactive.data={definitions:{},instances:{},instancesCustomEvents:{},instancesRestoreData:{},state:{},stateUpdateEvents:{}},JMain.r={listDefinitions:function(){return Object.keys(Reactive.data.definitions)},listInstances:function(){return Object.keys(Reactive.data.instances)},listInstancesCustomEvents:function(){const e={};for(const t in Reactive.data.instancesCustomEvents)e[t]=Object.keys(Reactive.data.instancesCustomEvents[t]);return e},listInstancesRestoreData:function(){const e={};for(const t in Reactive.data.instancesRestoreData)e[t]=Object.keys(Reactive.data.instancesRestoreData[t]);return e},listState:function(){return Object.keys(Reactive.data.state)},listStateUpdateEvents:function(){const e={};for(const t in Reactive.data.stateUpdateEvents)e[t]=Reactive.data.stateUpdateEvents[t].filter((e=>void 0!==e)).length;return e},define:function(e,t){if(Reactive.data.definitions[e])return!1;const a={};return a.data=t.data??{},a.events=t.events??{},a.methods=t.methods??{},Reactive.data.definitions[e]=a,!0},init:function(e,t){const a=Reactive.data.definitions[t.type];if(!a)return console.error(`Type '${t.type}' not defined!`),!1;if(void 0!==Reactive.data.instances[e])return console.error(`ID '${e}' already exists!`),!1;if(a.el=t.el,a.type=t.type,a.parent=e.includes(".")?e.split(".").slice(0,-1).join("."):"",t.data)for(const e in t.data)a.data.hasOwnProperty(e)&&(a.data[e]=t.data[e]);for(const t in a.data)a.data[t]instanceof ReactiveVar||(JMain.r.set(e+"."+t,a.data[t]),a.data[t]=JMain.r.ref(e+"."+t));Reactive.data.instances[e]=Reactive.initReactive(new Reactive(e,a),e),Reactive.data.instancesCustomEvents[e]={};const n=[];if(a.events){if(a.events.create){const t=Reactive.delayRefresh;t||(Reactive.delayRefresh=!0),a.events.create.call(Reactive.data.instances[e]),t||(Reactive.delayRefresh=!1,JMain.r.refresh(null))}if(a.events.update)for(const t in a.data)a.events.update[t]&&(JMain.r.attach(a.data[t],a.events.update[t],e),n.push(a.data[t]));a.events.destroy&&Reactive.data.instances[e].$el.on("jqreDestroy",a.events.destroy.bind(Reactive.data.instances[e]));for(const t in a.events)if("create"!==t&&"update"!==t)if("object"==typeof a.events[t])for(const n in a.events[t]){let i=a.events[t][n],s=null,r={};"function"!=typeof i&&(r=i.data??{},s=i.useCapture??null,i=i.handler),Reactive.data.instances[e].$el.on(t,n,r,(function(t){const a=Reactive.delayRefresh;a||(Reactive.delayRefresh=!0),i.call(Reactive.data.instances[e],t),a||(Reactive.delayRefresh=!1,JMain.r.refresh(null))}),s)}else Reactive.data.instancesCustomEvents[e][t]=a.events[t]}for(const e of n)JMain.r.refresh(e);return!0},trigger:function(e,t,a=null){return!!Reactive.data.instances.hasOwnProperty(e)&&Reactive.data.instances[e].$emit(t,a)},destroy:function(e){if(Reactive.data.instances.hasOwnProperty(e)){const t=e+".";for(const e in Reactive.data.instances)e.substr(0,t.length)===t&&JMain.r.destroy(e);Reactive.data.instances[e].$el.trigger("jqreDestroy");for(const e in Reactive.data.state)e.substr(0,t.length)===t&&JMain.r.unset(e);if(delete Reactive.data.instancesCustomEvents[e],Reactive.data.instancesRestoreData[e]){for(const t in Reactive.data.instancesRestoreData[e])Reactive.data.instances[e].$restore(t);delete Reactive.data.instancesRestoreData[e]}return Reactive.data.instances[e].$el.off(),delete Reactive.data.instances[e],!0}return!1},get:function(e){return"string"!=typeof e&&(e=e.id),e?Reactive.data.state[e]??null:null},ref:function(e){return new ReactiveVar(e)},attach:function(e,t,a=null){if("string"!=typeof e&&(e=e.id),e&&Reactive.data.stateUpdateEvents[e]){for(const n in Reactive.data.stateUpdateEvents[e])if(Reactive.data.stateUpdateEvents[e][n].handler===t&&Reactive.data.stateUpdateEvents[e][n].instanceId===a)return n}else Reactive.data.stateUpdateEvents[e]=[];return Reactive.data.stateUpdateEvents[e].push({handler:t,instanceId:a})-1},deattach:function(e,t=null,a=null){if("string"!=typeof e&&(e=e.id),Reactive.data.stateUpdateEvents[e])if("function"==typeof t){for(const n in Reactive.data.stateUpdateEvents[e])if(Reactive.data.stateUpdateEvents[e][n].handler===t&&Reactive.data.stateUpdateEvents[e][n].instanceId===a)return delete Reactive.data.stateUpdateEvents[e][n],!0}else{if(isNaN(t))return delete Reactive.data.stateUpdateEvents[e],!0;if(Reactive.data.stateUpdateEvents[e][t])return delete Reactive.data.stateUpdateEvents[e][t],!0}return!1},refresh:async function(e,t=null,a=void 0){if(null===e)return void Reactive.refreshDelayedList.forEach((e=>{Reactive.refreshDelayedList.delete(e),JMain.r.refresh(e.idRef,e.handlerOrIndex,e.oldVal)}));if(Reactive.delayRefresh)return void Reactive.refreshDelayedList.add({idRef:e,handlerOrIndex:t,oldVal:a});"string"!=typeof e&&(e=e.id);let n=!1;const i=Reactive.delayRefresh;if(i||(Reactive.delayRefresh=!0),Reactive.data.stateUpdateEvents[e])if(void 0===a&&(a=JMain.r.get(e)),t)if("function"==typeof t){for(const i in Reactive.data.stateUpdateEvents[e])if(Reactive.data.stateUpdateEvents[e][i].handler===t){Reactive.data.stateUpdateEvents[e][i].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[e][i].instanceId],a),n=!0;break}}else isNaN(t)||Reactive.data.stateUpdateEvents[e][t]&&(Reactive.data.stateUpdateEvents[e][t].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[e][t].instanceId],a),n=!0);else for(const t in Reactive.data.stateUpdateEvents[e])Reactive.data.stateUpdateEvents[e][t]&&Reactive.data.instances[Reactive.data.stateUpdateEvents[e][t].instanceId]&&(Reactive.data.stateUpdateEvents[e][t].handler.call(Reactive.data.instances[Reactive.data.stateUpdateEvents[e][t].instanceId],a),n=!0);return i||(Reactive.delayRefresh=!1,JMain.r.refresh(null)),n},set:function(e,t,a=void 0){"string"!=typeof e&&(e=e.id);let n,i=JMain.r.get(e);if(i=/boolean|number|string/.test(typeof i)?i:JSON.parse(JSON.stringify(i)),void 0===a)n=t;else{if(n=/boolean|number|string/.test(typeof i)?i:JSON.parse(JSON.stringify(i)),"object"!=typeof n||null===n)return!1;n[t]=a}let s=!1;return s=/boolean|number|string/.test(typeof i)&&/boolean|number|string/.test(typeof variable)?i!==n:JSON.stringify(i)!==JSON.stringify(n),s&&(void 0===a?Reactive.data.state[e]=t:Reactive.data.state[e][t]=a,JMain.r.refresh(e,null,i)),!0},unset:function(e,t=null){"string"!=typeof e&&(e=e.id);const a=JMain.r.get(e),n=/boolean|number|string/.test(typeof a)?a:JSON.parse(JSON.stringify(a));if(null!==t){if("object"==typeof a&&null!==a&&t in a)return delete Reactive.data.state[e][t],Array.isArray(a)&&(Reactive.data.state[e]=a.filter((e=>void 0!==e))),JMain.r.refresh(e,null,n),!0}else if(e in Reactive.data.state){if(null==a);else if(Array.isArray(a))Reactive.data.state[e]=[];else switch(typeof a){case"object":Reactive.data.state[e]={};break;case"boolean":Reactive.data.state[e]=!1;break;case"string":Reactive.data.state[e]="";break;case"number":case"bigint":Reactive.data.state[e]=0;break;default:Reactive.data.state[e]=null}return JMain.r.refresh(e,null,n),delete Reactive.data.state[e],delete Reactive.data.stateUpdateEvents[e],!0}return!1}},JMain.r.data={definitions:Reactive.data.definitions,instances:Reactive.data.instances,instancesCustomEvents:Reactive.data.instancesCustomEvents,instancesRestoreData:Reactive.data.instancesRestoreData,state:Reactive.data.state,stateUpdateEvents:Reactive.data.stateUpdateEvents,map:Reactive.reactiveMap,refreshDelayedList:Reactive.refreshDelayedList};